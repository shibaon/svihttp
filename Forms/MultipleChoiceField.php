<?php

namespace Svi\HttpBundle\Forms;

class MultipleChoiceField extends ChoiceField
{

    public function getChoicesForRender()
    {
        $result = parent::getChoicesForRender(); // TODO: Change the autogenerated stub

        if (!$this->isRequired()) {
            unset($result[null]);
        }

        foreach ($result as $key => &$value) {
            $value['selected'] = in_array($key, $this->getData());
        }

        unset($value);

        return $result;
    }

    public function getTemplate()
    {
        return 'multiple_choice';
    }

    public function setData($data)
    {
        if ($data === null) {
            $this->data = [];
        } elseif (is_array($data)) {
            $this->data = $data;
        } else {
            throw new \Exception('Unsupported data type for multiple choice field');
        }
    }

    public function validateData()
    {
        if ($this->getRequired() && !$this->getData()) {
            $this->addError($this->getRequiredMessage() ? $this->getRequiredMessage() : 'forms.requiredError');
        }
        if (!$this->hasErrors()) {
            if ($this->getData()) {
                foreach ($this->getData() as $value) {
                    if (!array_key_exists($value, $this->getChoicesForRender())) {
                        $this->addError('forms.choicesIncorrect');
                    }
                }
            }
        }
    }

}